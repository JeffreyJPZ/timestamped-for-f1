services:
  
  cache:
    build:
      context: ./services/cache
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - 6379
    volumes:
      - ./services/cache/data:/data

  cache-api:
    build:
      context: ./services/cache-api
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - 6666
    depends_on:
      - cache
    environment:
      CACHE_HOST: "${CACHE_HOST}"
      CACHE_PORT: "${CACHE_PORT}"
      CACHE_USERNAME: "${CACHE_USERNAME}"
      CACHE_PASSWORD: "${CACHE_PASSWORD}"
      CACHE_DB: "${CACHE_DB}"
      CACHE_API_IP: "${CACHE_API_IP}"
      CACHE_API_PORT: "${CACHE_API_PORT}"

  openf1-live-mq:
    build:
      context: ./services/openf1-live-mq
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - 5672
      - 15672

  openf1-db:
    build:
      context: ./services/openf1-db
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - 27017
    volumes:
      - ./services/openf1-db/data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${OPENF1_DB_ROOT_USERNAME}"
      MONGO_INITDB_ROOT_PASSWORD: "${OPENF1_DB_ROOT_PASSWORD}"

  openf1:
    image: ghcr.io/jeffreyjpz/timestamped-for-f1-openf1:latest
    ports:
      - "8000:8000"
    depends_on:
      - openf1-db
    environment:
      MONGO_CONNECTION_STRING: "mongodb://${OPENF1_DB_ROOT_USERNAME}:${OPENF1_DB_ROOT_PASSWORD}@openf1-db:${OPENF1_DB_PORT}"
      OPENF1_DB_NAME: "${OPENF1_DB_NAME}"

  historical-api:
    build:
      context: ./historical/api
      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    depends_on:
      - historical-db
    environment:
      SQLALCHEMY_URL: "postgresql://${HISTORICAL_DB_ROOT_USERNAME}:${HISTORICAL_DB_ROOT_PASSWORD}@historical-db:${HISTORICAL_DB_PORT}/${HISTORICAL_DB_NAME}"

  historical-processing:
    build:
      context: ./services/historical/processing
      dockerfile: Dockerfile
    depends_on:
      - openf1
      - openf1-db
      - historical-db
    environment:
      OPENF1_ADDRESS: "openf1:8000"
      SQLALCHEMY_URL: "postgresql://${HISTORICAL_DB_ROOT_USERNAME}:${HISTORICAL_DB_ROOT_PASSWORD}@historical-db:${HISTORICAL_DB_PORT}/${HISTORICAL_DB_NAME}"

  historical-db:
    image: postgres:17.5
    restart: unless-stopped
    expose:
      - 5432
    volumes:
      - ./services/historical-db/data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: "${HISTORICAL_DB_ROOT_USERNAME}"
      POSTGRES_PASSWORD: "${HISTORICAL_DB_ROOT_PASSWORD}"
      POSTGRES_DB: "${HISTORICAL_DB_NAME}"

  web-api:
    build:
      context: ./services/web-api
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - cache
      - cache-api
      - openf1
      - openf1-db

  web-server:
    build:
      context: ./services/web-server
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - cache
      - cache-api
      - openf1
      - openf1-db
      - web-api
    cap_add:
      - NET_ADMIN
    volumes:
      - ./services/web-server/data/data:/data
      - ./services/web-server/data/config:/config
